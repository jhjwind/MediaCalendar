<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
  <head>
  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  	<title>untitled</title>
  	<script type="text/javascript" src="jquery-1.4.2.js"></script>
  	<script type="text/javascript" src="background-init.js"></script>
    <script type="text/javascript" src="schedule-scraper.js"></script>
    <script type="text/javascript" src="tv_shows.js"></script>
    <script type="text/javascript">
      //schedule('The Amazing Race', onResults);
      
      function onResults(episodes){
        console.log(episodes);
      }

			// Inject javascript
			chrome.browserAction.onClicked.addListener(function(tab) {
				chrome.tabs.getSelected(null, function(tab) {
					chrome.tabs.executeScript(tab.id, {file: "content_script.js"});
					var calTab = null;
					chrome.tabs.create({ url: "https://www.google.com/calendar/" }, function(t) {
					  calTab = t;
					  console.log('' + t.status);
					});
					
					if(tab.url.match(/http:\/\/www.youtube.com\/watch\?v\=([A-Za-z0-9_]|\-){11}/)) {
					  //var calUrl = "http://www.google.com/calendar/render?tab=mc";
					  var timeInfo = new Date();
					  var year = timeInfo.getFullYear();
					  var month = timeInfo.getMonth() + 1;
					  var day = timeInfo.getDate();
					  var hours = timeInfo.getHours();
					  var mins = timeInfo.getMinutes();
					  var secs = timeInfo.getSeconds();
					  
					  var startTime = "" + year + "" + month + "" + day + "T" + hours + "" + mins + "" + secs;
					  var endTime = "/" + year + "" + month + "" + day + "T" + hours + "" + (mins + 1) + "" + secs;
					  var timeStr = startTime + endTime;
					  //var desc = ripDescription(tab);
					  
					  var port = chrome.tabs.connect(tab.id);
					  port.postMessage({ act: "get description"});
					  port.onMessage.addListener(function getResp(response) {
					  	  localStorage['description'] = response.description;
					  });
					  
					  //chrome.tabs.executeScript(tab.id, { code: "getVideoDescription()" }, null);
					  
					  var eventInfo = {
					  	sf: 'true',
					  	output: 'js',
					  	action: 'CREATE', 
					  	crm: 'BUSY',
					  	icc: 'PUBLIC',
					  	text: tab.title,
					  	location: tab.url,
					  	details: localStorage['description'] ? localStorage['description'] : "N/A",
					  	dates: timeStr,
					  	src: null,
					  	scp: 'ONE',
					  	secid: secid
					  }
					  
					  addEvent(eventInfo, null);
					  //window.close();
					}
				});
			 });
			
      
      /*chrome.extension.onRequest.addListener(function(req, sender, resp) {
      	if(req.action == "add") {
      	  console.log(sender.tab ? "Add from tab" : "Add from extern");
      	  // get relevant info
      	  var eventTitle = req.title;
      	  var videoUrl = req.url;
      	  var year = req.year;
      	  var month = req.month;
      	  var date = req.day;
      	  var trueHour = req.hours;
      	  var medHour = trueHour % 12;
      	  var min = req.mins;
      	  console.log(req);
      	  
      	  // construct quick add string
      	  var nameStr = "" + month + "/" + date + "/" + year + " ";
      	  
      	  if(medHour == 0)
      	  	nameStr += "12"
      	  else
      	  	nameStr += medHour;
      	  
      	  if(trueHour > 11)
      	  	nameStr += "pm ";
      	  else
      	  	nameStr += "am ";
      	  
      	  nameStr += eventTitle;
      	  
      	  // find calendar tab
      	  var calWin = null;
      	  var views = chrome.extension.getViews({ type: "tab" });
      	  for(var i = 0; i < views.length; i++) {
      	  	if(views[i].location.href == req.cal.url) {
      	  	  calWin = views[i];
      	  	  break;
      	  	}
      	  }
      	  
      	  if(calWin == null) {
      	  	resp({ success: "false" });
      	  	return;
      	  }
      	  
      	  // lookup quickadd textbox and add button
      	  $("textarea:contains(1r)").attr('textContent', nameStr);
      	  $("div.qab-container.gcal-popup > div.goog-inline-block.goog-imageless-button").trigger('mouseup');
      	  
      	  resp({ success: "true" });
      	}
      });*/
    </script>
  </head>
</html>
